name: Release
on:
  push:
    branches:
      - master

jobs:
  release:
    name: Create Release
    runs-on: macos-latest
    timeout-minutes: 10
    steps:
      - name: Checkout Changes
        uses: actions/checkout@v2

      - name: Configure semantic-release
        run: |
          printf "module.exports = {
              tagFormat: '\${version}',
              plugins: [
                  '@semantic-release/commit-analyzer',
                  '@semantic-release/release-notes-generator',
                  '@semantic-release/github',
                  ['@semantic-release/changelog', {
                      'changelogFile': 'CHANGELOG.md',
                      'changelogTitle': '# DiscordRPC Changelog',
                  }],
                  ['@semantic-release/git', {
                      'assets': ['CHANGELOG.md'],
                      'message': 'docs: changelog generated by CI'
                  }],
              ],
            };" > .releaserc.js

      - name: Create GitHub Release and Push Documentation
        id: semantic
        uses: cycjimmy/semantic-release-action@v2
        with:
          extra_plugins: |
            @semantic-release/changelog
            @semantic-release/git
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: GitHub Actions
          GIT_AUTHOR_EMAIL: actions@github.com
          GIT_COMMITTER_NAME: GitHub Actions
          GIT_COMMITTER_EMAIL: actions@github.com

      - name: Generate Jazzy Documentation
        if: steps.semantic.outputs.new_release_published == 'true'
        env:
            VERSION: ${{ steps.semantic.outputs.new_release_version }}
        run: |
            gem install jazzy
            jazzy \
                --output htmlDocumentation \
                --config .github/jazzy.yml \
                --module-version "$VERSION" \
                --readme README.md \
                --github-file-prefix "https://github.com/aeddi/DiscordRPC/tree/$VERSION"

      - name: Deploy Documentation on GitHub Pages
        if: steps.semantic.outputs.new_release_published == 'true'
        uses: JamesIves/github-pages-deploy-action@4.1.4
        with:
          branch: gh-pages
          folder: htmlDocumentation
          clean: true
          clean-exclude: img/favicon
